<!DOCTYPE html>
<html lang="pt-br">

<head>
    <title>Line Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <!-- <script src="http://www.chartjs.org/samples/latest/utils.js"></script> -->
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="./css/dashbord.css">
    

    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>

    <script src="./js/validarSessao.js"></script> <!--VALIDAÇÃO DA SESSÃO-->

</head>

<body>

<body onload="validarSessao(), obterDadosGrafico()">


    <div class="menu-lateral">

        <div>
            <img class="img_login" src="./assets/icone-dashboard.png" alt="imagem de um bonequinho">
        </div>

        <div class="titulo">
            <h4>Menu</h4>
        </div>
        <div class="navbar">
    <ul>
        <li id="li_endereco" class="li_endereco"><a href="./endereco.html">Endereço</a></li>
        <li class="li_transporte"><a href="./dahsboard-transporte.html">Transporte</a></li>
        <li class="li_armazenamento ativo"><a href="./dashbord.html">Armazenamento</a></li>
        <li><a onclick="limparSessao()">Sair</a></li>
    </ul>
        </div>
    </div>

    <div class="container-grafico">
       
        <h1>Seja bem vindo, <span id="mensagem_usuario"></span></h1>
        
        <h2>Armazenamento</h2>

        <div class="grafico">
            <section id="section_umidade">
                <canvas class="grafico_umidade" id="dht11Umidade"></canvas>
            </section>

            <section id="section_temperatura">
                <canvas class="grafico_temperatura" id="dht11Temperatura"></canvas>
            </section>
        </div>

        <section class="alerta_umidade">

            <p class="p_umidade">Alerta Umidade</p>

            <div class="quadrados">
                <div class="alerta quadrado1">
                    <p class="p_registro">25%</p>
                </div>
                <div class="alerta quadrado2">
                    <p class="p_registro">30%</p>
                </div>
                <div class="alerta quadrado3">
                    <p class="p_registro">35%</p>
                </div>
                <div class="alerta quadrado4">
                    <p class="p_registro">40%</p>
                </div>
                <div class="alerta quadrado5">
                    <p class="p_registro">70%</p>
                </div>
                <div class="alerta quadrado6">
                    <p class="p_registro">75%</p>
                </div>
                <div class="alerta quadrado7">
                    <p class="p_registro">80%</p>
                </div>
                <div class="alerta quadrado8">
                    <p class="p_registro">+80%</p>
                </div>
            </div>

        </section>

        <section class="alerta_temperatura">

            <p class="p_temperatura">Alerta Temperatura</p>

            <div class="quadrados">
                <div class="alerta quadrado1">
                    <p class="p_registro">0°C</p>
                </div>
                <div class="alerta quadrado2">
                    <p class="p_registro">1°C</p>
                </div>
                <div class="alerta quadrado3">
                    <p class="p_registro">2°C</p>
                </div>
                <div class="alerta quadrado4">
                    <p class="p_registro">3°C</p>
                </div>
                <div class="alerta quadrado5">
                    <p class="p_registro">7°C</p>
                </div>
                <div class="alerta quadrado6">
                    <p class="p_registro">8°C</p>
                </div>
                <div class="alerta quadrado7">
                    <p class="p_registro">9°C</p>
                </div>
                <div class="alerta quadrado8">
                    <p class="p_registro">10°C</p>
                </div>
            </div>
        </section>

    </div>


    <!-- <h1>Sensor Luminosidade</h1> -->
    <section style="width: 100%; display: none">
        <canvas id="luminosidade"></canvas>
    </section>
    <!-- <h1>Sensor LM 35 - Temperatura</h1> -->
    <section style="width: 100%; display: none;">
        <canvas id="lm35Temperatura"></canvas>
    </section>
    <!-- <h1>Sensor Chave</h1> -->
    <section style="width: 100%; display: none">
        <canvas id="chave"></canvas>
    </section>




    <script>

        // section_umidade.style.backgroundColor = "green";
        /* -- dht11Umidade -- */
                /* -- luminosidade -- */
        var contextoLuminosidade = document.getElementById('luminosidade').getContext('2d');
        contextoLuminosidade.canvas.width = 1000;
        contextoLuminosidade.canvas.height = 300;
        var luminosidade = new Chart(
            contextoLuminosidade,
            {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Luminosidade',
                        type: 'line',
                        borderColor: ['#ffd902'],
                        backgroundColor: ['#ffe135']
                    }]
                },
                options: {
                    scales: {
                        xAxes: [{
                            distribution: 'series',
                            ticks: {
                                beginAtZero: true
                            }
                        }],
                        yAxes: [{
                            scaleLabel: {
                                display: true,
                                labelString: 'Luminosidade'
                            },
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                    animation: {
                        duration: 0
                    }
                }
            }
        );

        /* -- lm35Temperatura */
        var contextoLm35Temperatura = document.getElementById('lm35Temperatura').getContext('2d');
        contextoLm35Temperatura.canvas.width = 1000;
        contextoLm35Temperatura.canvas.height = 300;
        var lm35Temperatura = new Chart(
            contextoLm35Temperatura,
            {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Temperatura',
                        type: 'line',
                        borderColor: ['rgb(139, 0, 0)'],
                        backgroundColor: ['rgb(255, 102, 102)']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: (ctx) => 'Point Style: ' + ctx.chart.data.datasets[0].pointStyle,
                            scales: {
                                xAxes: [{
                                    distribution: 'series',
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }],
                                yAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Temperatura'
                                    },
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            },
                            animation: {
                                duration: 0
                            }
                        }
                    }
                }
            }
        );

        /* -- chave */
        var contextoChave = document.getElementById('chave').getContext('2d');
        contextoChave.canvas.width = 1000;
        contextoChave.canvas.height = 300;
        var chave = new Chart(
            contextoChave,
            {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Chave',
                        type: 'line',
                        borderColor: ['#ffd902'],
                        backgroundColor: ['#ffe135']
                    }]
                },
                options: {
                    scales: {
                        xAxes: [{
                            distribution: 'series',
                            ticks: {
                                beginAtZero: true
                            }
                        }],
                        yAxes: [{
                            scaleLabel: {
                                display: true,
                                labelString: 'Chave'
                            },
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                    animation: {
                        duration: 0
                    }
                }
            }
        );

        var paginacao = {};
        var tempo = {};
        // function obterDados(grafico, endpoint) {
        //     var http = new XMLHttpRequest();
        //     http.open('GET', 'http://localhost:3000/sensores/' + endpoint, false);
        //     http.send(null);
        //     var valores = JSON.parse(http.responseText);
        //     if (paginacao[endpoint] == null) {
        //         paginacao[endpoint] = 0;
        //     }
        //     if (tempo[endpoint] == null) {
        //         tempo[endpoint] = 0;
        //     }
        //     // Exibir à partir do último elemento exibido anteriormente
        //     var ultimaPaginacao = paginacao[endpoint];
        //     paginacao[endpoint] = valores.length;

        //     var valores = valores.slice(ultimaPaginacao);
        //     valores.forEach((valor) => {
        //         //Máximo de 60 itens exibidos no gráfico
        //         if (grafico.data.labels.length == 10 && grafico.data.datasets[0].data.length == 10) {
        //             grafico.data.labels.shift();
        //             grafico.data.datasets[0].data.shift();
        //         }


        //         if (endpoint == 'dht11/temperatura') {
        //             var valorT = valor;
                    
        //             grafico.data.labels.push(tempo[endpoint]++);
        //             grafico.data.datasets[0].data.push(parseFloat(valorT));
    
        //             console.log(valorT.dht11_temperatura);
    
        //             grafico.update();
        //         } else {
        //             var valorH = valor;
        //             grafico.data.labels.push(tempo[endpoint]++);
        //             grafico.data.datasets[0].data.push(parseFloat(valorH));
    
        //             console.log(valorH.dht11_temperatura);
    
        //             grafico.update();
        //         }
        //         // var valorMenor = valor < 10;
        //         if (valorT >= 3 && valorT <=7) {
        //             section_temperatura.style.boxShadow = "0 0 10px 4px #40cb83"
        //         } else if(valorT == 2 || valorT == 8){
        //             section_temperatura.style.boxShadow = "0 0 10px 4px #DAA520"
        //         } else if(valorT == 1){
        //             section_temperatura.style.boxShadow = "0 0 10px 4px #FF4500"
        //         } else{
        //             section_temperatura.style.boxShadow = "0 0 10px 4px red"
        //         }

        //         if (valorH > 10) {
        //             section_umidade.style.boxShadow = "0 0 10px 4px #40cb83"
        //         }
        //     })
        // }

        // setInterval(() => {
        //     // obterDados(dht11Umidade, 'dht11/umidade');
        //     // obterDados(dht11Temperatura, 'dht11/temperatura');
        //     // obterDados(luminosidade, 'luminosidade');
        //     // obterDados(lm35Temperatura, 'lm35/temperatura');
        //     // obterDados(chave, 'chave');
        // }, 1000);

        //  function verde(){
        //     dht11Umidade.style.backgroundColor = "red"
        // }

    </script>
</body>

</html>

<script>
    function negrito(id) {
        var linkAtivo = id;
        linkAtivo.style = 'color: red'
    }
</script>


<script>
	window.fwSettings={
	'widget_id':153000000830
	};
	!function(){if("function"!=typeof window.FreshworksWidget){var n=function(){n.q.push(arguments)};n.q=[],window.FreshworksWidget=n}}() 
</script>
<script type='text/javascript' src='https://widget.freshworks.com/widgets/153000000830.js' async defer></script>

<script>
    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models

    let proximaAtualizacao;

    function obterDadosGrafico() {

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/`, { cache: 'no-store' }).then(function (response) {        
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();
                    plotarGrafico(resposta);
                    alerta(resposta[0]);
                });

            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e,
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta) {

        console.log('iniciando plotagem do gráfico...');

        var contextoDht11Umidade = document.getElementById('dht11Umidade').getContext('2d');
        var dht11Umidade = new Chart(
            contextoDht11Umidade,
            {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Umidade',
                            type: 'line',
                            data: [],
                            borderColor: ['rgb(0, 0, 255)'],
                            backgroundColor: ['rgb(0, 0, 255)'],
                            fill: false,
                        }
                    ]
                },

                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: (ctx) => 'Point Style: ' + ctx.chart.data.datasets[0].pointStyle,
                            scales: {
                                xAxes: [{
                                    distribution: 'series',
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }],

                                yAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Umidade'
                                    },

                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            },
                            animation: {
                                duration: 0
                            }
                        }
                    }
                }
            }
        );

        /* -- dht11Temperatura -- */
        var contextoDht11Temperatura = document.getElementById('dht11Temperatura').getContext('2d');
        var dht11Temperatura = new Chart(
            contextoDht11Temperatura,
            {
                type: 'line',
                data: {
                    datasets: [{
                        label: "Temperatura",
                        type: 'line',
                        data: [],
                        borderColor: ['rgb(128, 0, 128)'],
                        backgroundColor: ['rgb(128, 0, 128)'],
                        fill: false,
                    }]
                },

                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: (ctx) => 'Point Style: ' + ctx.chart.data.datasets[0].pointStyle,

                            scales: {
                                xAxes: [{
                                    distribution: 'series',
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }],

                                yAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Temperatura'
                                    },
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            },
                            animation: {
                                duration: 0
                            }
                        }
                    }
                }
            }
        );


        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];

            dht11Umidade.data.labels.push(registro.Dia)
            dht11Umidade.data.datasets[0].data.push(registro.Umidade);
            dht11Temperatura.data.labels.push(registro.Dia)
            dht11Temperatura.data.datasets[0].data.push(registro.Temperatura);
            // labels.push(registro.momento_grafico);
            // dados.datasets[0].data.push(registro.umidade);
            // dados.datasets[1].data.push(registro.temperatura);
        }

        console.log(dht11Umidade)
        console.log(dht11Temperatura)

        dht11Umidade.update()
        dht11Temperatura.update()


        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        // console.log(labels)
        console.log('Dados:')
        // console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        // const config = {
        //     type: 'line',
        //     data: dados,
        // };

        // // Adicionando gráfico criado em div na tela
        // let myChart = new Chart(
        //     document.getElementById(`myChartCanvas$`),
        //     config
        // );

        
        setTimeout(() => atualizarGrafico(dht11Umidade.data, dht11Umidade, dht11Temperatura.data, dht11Temperatura), 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas,

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(dados, myChart, dadosTemperatura, chartTemperatura) {

        fetch(`/medidas/tempo-real/`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    // obterdados();
                    // alertar(novoRegistro, idAquario);

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

    
                    if (novoRegistro[0].Dia == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].Dia)

                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])

                        console.log("Horário do último dado capturado 2:")
                        console.log(dadosTemperatura.labels[dadosTemperatura.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico

                      // --  dados.labels.shift(); // apagar o primeiro
                        dados.labels.shift(); // Meu
                        dadosTemperatura.labels.shift();

                       //  -- dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento
                       dados.labels.push(novoRegistro[0].Dia); // Meu
                       dadosTemperatura.labels.push(novoRegistro[0].Dia); // Meu

                        // dht11Temperatura.data.labels.push(registro.Dia)
                        // dht11Temperatura.data.datasets[0].data.push(registro.Temperatura); //

                       // -- dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.shift(); // Meu
                        dadosTemperatura.datasets[0].data.shift();

                       // -- dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade
                        dados.datasets[0].data.push(novoRegistro[0].Umidade); // Meu
                        dadosTemperatura.datasets[0].data.push(novoRegistro[0].Temperatura); 

                       // -- dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                    //     dados.datasets[0].data.shift(); //Meu
                    //     dadosTemperatura.datasets[0].data.shift(); 

                    //    // -- dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura
                    //     dados.datasets[0].data.push(novoRegistro[0].Temperatura); // Meu 
                    //     dadosTemperatura.datasets[0].data.push(novoRegistro[0].Temperatura); 

                        myChart.update();
                        chartTemperatura.update();

                        
                        alerta(novoRegistro[0]);
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart, dadosTemperatura, chartTemperatura), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart, dadosTemperatura, chartTemperatura), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function alerta(resposta){
        // var valorMenor = resposta < 10;
             if (resposta.Temperatura >= 3 && resposta.Temperatura <= 7.9) {
                    section_temperatura.style.boxShadow = "0 0 10px 4px #40cb83"
                    } else if((resposta.Temperatura >= 2 && resposta.Temperatura < 2.9) || (resposta.Temperatura >= 8 && resposta.Temperatura <= 8.9)){
                        section_temperatura.style.boxShadow = "0 0 10px 4px yellow"
                     } else if((resposta.Temperatura >= 1 && resposta.Temperatura <= 1.9) || (resposta.Temperatura >= 9 && resposta.Temperatura <= 9.9)){
                         section_temperatura.style.boxShadow = "0 0 10px 4px orange"
                    } else if (resposta.Temperatura <= 0 || resposta.Temperatura >= 10){
                         section_temperatura.style.boxShadow = "0 0 10px 4px red"
                    }
    
                     if (resposta.Umidade >= 40.9 &&  resposta.Umidade <= 70.9) {
                         section_umidade.style.boxShadow = "0 0 10px 4px #40cb83"
                    } else if((resposta.Umidade >= 35 && resposta.Umidade <= 35.9) || (resposta.Umidade >= 75 && resposta.Umidade <= 75.9)){
                        section_umidade.style.boxShadow = "0 0 10px 4px yellow"
                    }  else if((resposta.Umidade >= 30 && resposta.Umidade <= 30.9) || (resposta.Umidade == 80)){
                         section_umidade.style.boxShadow = "0 0 10px 4px orange"     
                    } else if((resposta.Umidade >= 25 && resposta.Umidade <= 25.9) || (resposta.Umidade >= 80)){
                        section_umidade.style.boxShadow = "0 0 10px 4px red"     

                    }
    }
</script>

